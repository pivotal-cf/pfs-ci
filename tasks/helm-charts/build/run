#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

build_root=$PWD

source "$build_root/git-pfs-ci/tasks/scripts/common.sh"

pushd git-riff/helm-charts
  helm init --client-only

  riff_version=$(cat riff-version/version)
  chart_version=$(grep version git-riff/helm-charts/riff/Chart.yaml  | awk '{print $2}')

  helm package riff --version "$chart_version"

  chart_file=$(basename riff*tgz)

  cat > "${build_root}/helm-charts-install/riff-${chart_version}-install-example.sh" << EOM
#!/usr/bin/env bash

script_name=\`basename "\$0"\`

set -o errexit
set -o nounset
set -o pipefail

if (( \$# < 1 )); then
    echo
    echo "Usage:"
    echo
    echo "   \$script_name <chart-name> <extra-helm-args>"
    echo
    exit 1
fi

set -x

chart_name="\$1"
shift

helm install "\${chart_name}" \
--version="${chart_version}" \
--set rbac.create=false \
--set functionController.image.tag=${riff_version},functionController.sidecar.image.tag=${riff_version},topicController.image.tag=${riff_version},httpGateway.image.tag=${riff_version} \
"\$@"

EOM

  cp "$chart_file" "$build_root/helm-charts/"

  set +e
  curl -sfL "$HELM_CHARTS_URL/index.yaml" > existing_index.yaml
  if [ "0" != "$?" ]; then
    rm -f existing_index.yaml
  fi
  set -e

  if [ -f existing_index.yaml ]; then
    helm repo index "$build_root/helm-charts" --url "$HELM_CHARTS_URL" --merge existing_index.yaml
  else
    helm repo index "$build_root/helm-charts" --url "$HELM_CHARTS_URL"
  fi

  echo "$chart_version" > "$build_root/helm-charts-latest-version/latest_version"
  echo "riff" > "$build_root/helm-charts-latest-name/latest_name"

popd
